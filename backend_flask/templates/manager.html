{% extends "layout.html" %}
{% block content %}
<div class="container">
    <!-- Company Header -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <h1 style="margin: 0;">{{ company_name or 'Company' }}</h1>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 320px; gap: 1.5rem;">
        <!-- Calendar and Create Event Section -->
        <div>
            <!-- Calendar Section -->
            <div class="card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                <h2 style="margin-top: 0;">Calendar View</h2>
                <div id="calendar" style="min-height: 500px;">
                    {% set month_names = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
                    
                    {# Calculate previous and next month/year #}
                    {% set prev_month = month - 1 if month > 1 else 12 %}
                    {% set prev_year = year if month > 1 else year - 1 %}
                    {% set next_month = month + 1 if month < 12 else 1 %}
                    {% set next_year = year if month < 12 else year + 1 %}
                    
                    <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <a href="?month={{ prev_month }}&year={{ prev_year }}" class="btn btn-secondary" style="padding: 0.5rem 1rem; text-decoration: none;">‚Üê {{ month_names[prev_month - 1][:3] }}</a>
                        <h3 style="margin: 0;">{{ month_names[month - 1] }} {{ year }}</h3>
                        <a href="?month={{ next_month }}&year={{ next_year }}" class="btn btn-secondary" style="padding: 0.5rem 1rem; text-decoration: none;">{{ month_names[next_month - 1][:3] }} ‚Üí</a>
                    </div>
                    
                    {# Calculate calendar grid - find first day of month and days in month #}
                    {% set days_in_month = [31, 29 if year % 4 == 0 and (year % 100 != 0 or year % 400 == 0) else 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month - 1] %}
                    {# Simple day of week calculation (not perfect but works for recent years) #}
                    {% set first_day_offset = ((year - 2000) * 365 + ((year - 2000) // 4) + [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334][month - 1] + (1 if month > 2 and year % 4 == 0 and (year % 100 != 0 or year % 400 == 0) else 0)) % 7 %}
                    
                    <div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
                        <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Sun</div>
                        <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Mon</div>
                        <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Tue</div>
                        <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Wed</div>
                        <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Thu</div>
                        <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Fri</div>
                        <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Sat</div>
                        
                        {# Empty cells before month starts #}
                        {% for i in range(first_day_offset) %}
                            <div class="calendar-day" style="min-height: 80px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: #f9f9f9;"></div>
                        {% endfor %}
                        
                        {# Days of the month #}
                        {% for day in range(1, days_in_month + 1) %}
                            {% set events_on_day = [] %}
                            {% for event in events %}
                                {% set event_date = event.start.split('T')[0].split('-') %}
                                {% set event_year = event_date[0]|int %}
                                {% set event_month = event_date[1]|int %}
                                {% set event_day = event_date[2]|int %}
                                {% if event_year == year and event_month == month and event_day == day %}
                                    {% set _ = events_on_day.append(event) %}
                                {% endif %}
                            {% endfor %}
                            
                            <div class="calendar-day" style="min-height: 80px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; {{ 'background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);' if events_on_day else '' }}">
                                <div style="font-size: 0.9rem; font-weight: {{ 'bold' if events_on_day else 'normal' }};">{{ day }}</div>
                                {% if events_on_day %}
                                    {% for event in events_on_day %}
                                        {% set assigned_count = event.assigned|length %}
                                        {% set capacity = event.capacity|int %}
                                        <details style="margin-top: 0.25rem;">
                                            <summary style="cursor: pointer; font-size: 0.7rem; color: var(--primary); background: rgba(255,255,255,0.9); padding: 0.25rem; border-radius: 3px; margin-bottom: 0.25rem;">{{ event.title }}</summary>
                                            <div style="font-size: 0.65rem; background: white; padding: 0.5rem; border-radius: 3px; margin-top: 0.25rem; border: 1px solid var(--border);">
                                                <div style="margin-bottom: 0.25rem;"><strong>Time:</strong> {{ event.start.split('T')[1][:5] }} - {{ event.end.split('T')[1][:5] }}</div>
                                                <div style="margin-bottom: 0.25rem;"><strong>Location:</strong> {{ event.location or 'TBD' }}</div>
                                                <div style="margin-bottom: 0.25rem;"><strong>Staff:</strong> {{ assigned_count }} / {{ capacity }}</div>
                                                {% if event.description %}
                                                    <div style="margin-bottom: 0.25rem;"><strong>Description:</strong> {{ event.description }}</div>
                                                {% endif %}
                                            </div>
                                        </details>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Create Event Form -->
            <div class="card" style="padding: 1.5rem;">
                <h3 style="margin-top: 0;">Create New Event</h3>
                <details>
                    <summary class="btn btn-primary" style="display: inline-block; cursor: pointer; width: 100%; text-align: left;">+ Open Event Form</summary>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                        <form action="/events/create" method="POST">
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" name="title" placeholder="e.g. Wedding Service" required>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea name="description" rows="3" placeholder="Event details..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" name="date" required>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label>Start Time</label>
                                    <input type="time" name="start_time" required>
                                </div>
                                <div class="form-group">
                                    <label>End Time</label>
                                    <input type="time" name="end_time" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Location (Room)</label>
                                <input type="text" name="location" placeholder="e.g. Main Hall, Room 101" required>
                            </div>
                            <div class="form-group">
                                <label>Personnel Needed</label>
                                <input type="number" name="capacity" min="1" value="1" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Create Event</button>
                        </form>
                    </div>
                </details>
            </div>
        </div>
        
        <!-- Event Widgets Sidebar -->
        <div>
            <h2 style="margin-top: 0;">Events</h2>
            
            <!-- Invite Employees Card (Registration Code) -->
            <div class="card" style="padding: 1.5rem; margin-bottom: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                <h3 style="margin-top: 0; color: white;">üìã Invite Employees</h3>
                <p style="font-size: 0.9rem; margin: 0.5rem 0;">Share this code with new team members to let them join your company:</p>
                
                <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center;">
                    <div style="font-size: 0.8rem; margin-bottom: 0.5rem; opacity: 0.9;">Company Registration Code:</div>
                    <div style="font-size: 1.5rem; font-weight: bold; font-family: 'Courier New', monospace; letter-spacing: 3px;">{{ company_code or 'N/A' }}</div>
                </div>
                
                <p style="font-size: 0.85rem; margin: 0.5rem 0; opacity: 0.95;">
                    ‚úì Employees can use this code during registration<br>
                    ‚úì They'll automatically join your company<br>
                    ‚úì Share across your team safely
                </p>
            </div>
            
            <!-- Search & Filter Form -->
            <div class="card" style="padding: 1rem; margin-bottom: 1rem;">
                <form method="GET" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <!-- Keep month/year params in URL -->
                    <input type="hidden" name="month" value="{{ month }}">
                    <input type="hidden" name="year" value="{{ year }}">
                    
                    <div>
                        <label style="font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Search by name or location</label>
                        <input type="text" name="search" value="{{ search_query }}" placeholder="e.g. Wedding, Main Hall" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem;">
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem;">
                            <input type="checkbox" name="understaffed" value="true" {% if filter_understaffed %}checked{% endif %}>
                            Show only understaffed events
                        </label>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div>
                            <label style="font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">From</label>
                            <input type="date" name="date_start" value="{{ filter_date_start }}" style="width: 100%; padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem;">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">To</label>
                            <input type="date" name="date_end" value="{{ filter_date_end }}" style="width: 100%; padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button type="submit" class="btn btn-primary" style="padding: 0.5rem; font-size: 0.85rem;">Apply Filters</button>
                        <a href="{{ url_for('main.manager', month=month, year=year) }}" class="btn btn-secondary" style="padding: 0.5rem; font-size: 0.85rem; text-decoration: none; text-align: center;">Clear</a>
                    </div>
                </form>
                
                {% if search_query or filter_understaffed or filter_date_start or filter_date_end %}
                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); font-size: 0.8rem; color: var(--text-light);">
                        Showing {{ events|length }} of {{ all_events|length }} events
                    </div>
                {% endif %}
            </div>
            
            <!-- Events List with Separate Scrollbars -->
            {% if not events %}
                <p style="color: var(--text-light); font-size: 0.9rem;">No events found.</p>
            {% else %}
                <!-- Upcoming Events -->
                {% if upcoming_events %}
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 0.9rem; font-weight: bold; color: var(--primary); padding: 0.5rem 0; border-bottom: 2px solid var(--primary); margin-bottom: 0.75rem;">Upcoming</div>
                        <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
                            {% for event in upcoming_events %}
                                {% set assigned_count = event.assigned|length %}
                                {% set capacity = event.capacity|int %}
                                {% set progress = (assigned_count / capacity * 100)|round|int %}
                                {% if progress > 100 %}{% set progress = 100 %}{% endif %}
                                
                                <div class="event-widget card" style="padding: 1rem; font-size: 0.9rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                        <div style="font-weight: bold; color: var(--primary); flex: 1;">{{ event.title }}</div>
                                        <div style="display: flex; gap: 0.25rem;">
                                            <form action="/events/{{ event.id }}/edit" method="GET" style="display: inline;">
                                                <button type="submit" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;" title="Edit Event">‚úé</button>
                                            </form>
                                            <form action="/events/{{ event.id }}/delete" method="POST" style="display: inline;" onsubmit="return confirm('Delete this event?');">
                                                <button type="submit" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #f44336; color: white; border: none;" title="Delete Event">√ó</button>
                                            </form>
                                        </div>
                                    </div>
                                    <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.5rem;">{{ event.start.split('T')[0]|format_date }} ‚Ä¢ {{ event.start.split('T')[1][:5] }}</div>
                                    
                                    <div class="progress-container" style="margin: 0.5rem 0;">
                                        <div class="progress-bar" style="width: {{ progress }}%"></div>
                                    </div>
                                    <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.75rem;">
                                        {{ assigned_count }} / {{ capacity }} Staff
                                    </div>

                                    <details style="margin-top: 0.5rem;">
                                        <summary style="cursor: pointer; font-size: 0.85rem; color: var(--primary);">Manage ‚ñº</summary>
                                        <div style="padding-top: 0.5rem; border-top: 1px solid var(--border); margin-top: 0.5rem;">
                                            
                                            {% if event.assigned %}
                                                <div style="margin-bottom: 0.75rem;">
                                                    <strong style="font-size: 0.8rem;">Assigned Staff:</strong>
                                                    {% for uid in event.assigned %}
                                                        {% set emp = employees|selectattr('id', 'equalto', uid)|first %}
                                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem; align-items: center; padding: 0.35rem; background: #f0f8ff; border-radius: 3px;">
                                                            <span style="font-size: 0.75rem; flex: 1;">{{ emp.username if emp else uid[:8] }}</span>
                                                            <form action="/events/{{ event.id }}/unassign" method="POST" style="display:inline;" onsubmit="return confirm('Remove this employee?');">
                                                                <input type="hidden" name="user_id" value="{{ uid }}">
                                                                <button type="submit" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #ff6b6b; color: white; border: none;">‚úï</button>
                                                            </form>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                            
                                            {% if event.pending %}
                                                <div style="margin-bottom: 0.75rem;">
                                                    <strong style="font-size: 0.8rem;">Pending:</strong>
                                                    {% for uid in event.pending %}
                                                        {% set emp = employees|selectattr('id', 'equalto', uid)|first %}
                                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem; align-items: center; padding: 0.35rem; background: #fffde7; border-radius: 3px;">
                                                            <span style="font-size: 0.75rem; flex: 1;">{{ emp.username if emp else uid[:8] }}...</span>
                                                            <form action="/events/{{ event.id }}/confirm" method="POST" style="display:inline;">
                                                                <input type="hidden" name="user_id" value="{{ uid }}">
                                                                <button type="submit" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;">‚úì</button>
                                                            </form>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}

                                            {% if assigned_count < capacity %}
                                                <form action="/events/{{ event.id }}/assign" method="POST" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                    <select name="user_id" required style="padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem;">
                                                        <option value="">Assign employee...</option>
                                                        {% for emp in employees %}
                                                            {% if emp.id not in event.assigned and emp.id not in event.pending %}
                                                                <option value="{{ emp.id }}">{{ emp.username }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button type="submit" class="btn btn-primary" style="padding: 0.4rem; font-size: 0.8rem; flex: 1;">Assign</button>
                                                        <button type="button" class="btn btn-success" style="padding: 0.4rem; font-size: 0.8rem; background: #4caf50;" onclick="autofillShift('{{ event.id }}', '{{ event.title }}')">ü§ñ Auto-Fill</button>
                                                    </div>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </details>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Past Events -->
                {% if past_events %}
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 0.9rem; font-weight: bold; color: #999; padding: 0.5rem 0; border-bottom: 2px solid #ddd; margin-bottom: 0.75rem;">Past</div>
                        <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 300px; overflow-y: auto; padding-right: 0.5rem;">
                            {% for event in past_events %}
                                {% set assigned_count = event.assigned|length %}
                                {% set capacity = event.capacity|int %}
                                {% set progress = (assigned_count / capacity * 100)|round|int %}
                                {% if progress > 100 %}{% set progress = 100 %}{% endif %}
                                
                                <div class="event-widget card" style="padding: 1rem; font-size: 0.9rem; opacity: 0.6; background-color: #f5f5f5;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                        <div style="font-weight: bold; color: #999; flex: 1;">{{ event.title }}</div>
                                        <div style="display: flex; gap: 0.25rem;">
                                            <form action="/events/{{ event.id }}/edit" method="GET" style="display: inline;">
                                                <button type="submit" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;" title="Edit Event">‚úé</button>
                                            </form>
                                            <form action="/events/{{ event.id }}/delete" method="POST" style="display: inline;" onsubmit="return confirm('Delete this event?');">
                                                <button type="submit" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #f44336; color: white; border: none;" title="Delete Event">√ó</button>
                                            </form>
                                        </div>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #999; margin-bottom: 0.5rem;">{{ event.start.split('T')[0]|format_date }} ‚Ä¢ {{ event.start.split('T')[1][:5] }}</div>
                                    
                                    <div class="progress-container" style="margin: 0.5rem 0;">
                                        <div class="progress-bar" style="width: {{ progress }}%; background-color: #ddd;"></div>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #999; margin-bottom: 0.75rem;">
                                        {{ assigned_count }} / {{ capacity }} Staff
                                    </div>

                                    <details style="margin-top: 0.5rem;">
                                        <summary style="cursor: pointer; font-size: 0.85rem; color: #999;">Manage ‚ñº</summary>
                                        <div style="padding-top: 0.5rem; border-top: 1px solid var(--border); margin-top: 0.5rem;">
                                            
                                            {% if event.assigned %}
                                                <div style="margin-bottom: 0.75rem;">
                                                    <strong style="font-size: 0.8rem;">Assigned Staff:</strong>
                                                    {% for uid in event.assigned %}
                                                        {% set emp = employees|selectattr('id', 'equalto', uid)|first %}
                                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem; align-items: center; padding: 0.35rem; background: #f0f8ff; border-radius: 3px;">
                                                            <span style="font-size: 0.75rem; flex: 1;">{{ emp.username if emp else uid[:8] }}</span>
                                                            <form action="/events/{{ event.id }}/unassign" method="POST" style="display:inline;" onsubmit="return confirm('Remove this employee?');">
                                                                <input type="hidden" name="user_id" value="{{ uid }}">
                                                                <button type="submit" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #ff6b6b; color: white; border: none;">‚úï</button>
                                                            </form>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                            
                                            {% if event.pending %}
                                                <div style="margin-bottom: 0.75rem;">
                                                    <strong style="font-size: 0.8rem;">Pending:</strong>
                                                    {% for uid in event.pending %}
                                                        {% set emp = employees|selectattr('id', 'equalto', uid)|first %}
                                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem; align-items: center; padding: 0.35rem; background: #fffde7; border-radius: 3px;">
                                                            <span style="font-size: 0.75rem; flex: 1;">{{ emp.username if emp else uid[:8] }}...</span>
                                                            <form action="/events/{{ event.id }}/confirm" method="POST" style="display:inline;">
                                                                <input type="hidden" name="user_id" value="{{ uid }}">
                                                                <button type="submit" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;">‚úì</button>
                                                            </form>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}

                                            {% if assigned_count < capacity %}
                                                <form action="/events/{{ event.id }}/assign" method="POST" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                    <select name="user_id" required style="padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem;">
                                                        <option value="">Assign employee...</option>
                                                        {% for emp in employees %}
                                                            {% if emp.id not in event.assigned and emp.id not in event.pending %}
                                                                <option value="{{ emp.id }}">{{ emp.username }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                    <button type="submit" class="btn btn-primary" style="padding: 0.4rem; font-size: 0.8rem;">Assign</button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </details>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script>
function autofillShift(eventId, eventTitle) {
    if (!confirm(`Auto-fill remaining slots for "${eventTitle}"?`)) {
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.textContent = "‚è≥ Filling...";

    fetch(`/events/${eventId}/autofill`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(`‚ùå Error: ${data.error}`);
        } else {
            let msg = `‚úÖ Assigned ${data.count} employee(s).\n`;
            msg += `Staffing: ${data.previously_assigned + data.count}/${data.capacity}`;
            
            if (data.slots_unfilled && data.slots_unfilled > 0) {
                msg += `\n\n‚ö†Ô∏è WARNING: ${data.slots_unfilled} slot(s) remain unfilled`;
                msg += `\nInsufficient eligible employees available.`;
                if (data.errors && data.errors.length > 0) {
                    msg += `\n\nDetails:\n${data.errors.join('\n')}`;
                }
                alert(msg);
            } else if (data.errors && data.errors.length > 0) {
                msg += `\n\n‚ÑπÔ∏è Notes:\n${data.errors.join('\n')}`;
                alert(msg);
            } else {
                alert(msg + "\n\n‚ú® All slots filled!");
            }
            // Reload page to show updates
            location.reload();
        }
    })
    .catch(error => {
        alert(`Error: ${error.message}`);
        btn.disabled = false;
        btn.textContent = "ü§ñ Auto-Fill";
    });
}
</script>
{% endblock %}