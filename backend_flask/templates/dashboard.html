{% extends "layout.html" %}
{% block content %}
<div class="container">
    <div style="display: grid; grid-template-columns: 1fr 320px; gap: 1.5rem;">
        <!-- Calendar Section -->
        <div class="card" style="padding: 1.5rem;">
            <h2 style="margin-top: 0;">My Schedule</h2>
            <div id="calendar" style="min-height: 500px;">
                {% set month_names = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
                
                {# Calculate previous and next month/year #}
                {% set prev_month = month - 1 if month > 1 else 12 %}
                {% set prev_year = year if month > 1 else year - 1 %}
                {% set next_month = month + 1 if month < 12 else 1 %}
                {% set next_year = year if month < 12 else year + 1 %}
                
                <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <a href="?month={{ prev_month }}&year={{ prev_year }}" class="btn btn-secondary" style="padding: 0.5rem 1rem; text-decoration: none;">← {{ month_names[prev_month - 1][:3] }}</a>
                    <h3 style="margin: 0;">{{ month_names[month - 1] }} {{ year }}</h3>
                    <a href="?month={{ next_month }}&year={{ next_year }}" class="btn btn-secondary" style="padding: 0.5rem 1rem; text-decoration: none;">{{ month_names[next_month - 1][:3] }} →</a>
                </div>
                
                {# Calculate calendar grid - find first day of month and days in month #}
                {% set days_in_month = [31, 29 if year % 4 == 0 and (year % 100 != 0 or year % 400 == 0) else 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month - 1] %}
                {# Simple day of week calculation (not perfect but works for recent years) #}
                {% set first_day_offset = ((year - 2000) * 365 + ((year - 2000) // 4) + [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334][month - 1] + (1 if month > 2 and year % 4 == 0 and (year % 100 != 0 or year % 400 == 0) else 0)) % 7 %}
                
                <div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
                    <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Sun</div>
                    <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Mon</div>
                    <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Tue</div>
                    <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Wed</div>
                    <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Thu</div>
                    <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Fri</div>
                    <div style="text-align: center; font-weight: bold; padding: 0.5rem; background: var(--bg-secondary);">Sat</div>
                    
                    {# Empty cells before month starts #}
                    {% for i in range(first_day_offset) %}
                        <div class="calendar-day" style="min-height: 80px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: #f9f9f9;"></div>
                    {% endfor %}
                    
                    {# Days of the month #}
                    {% for day in range(1, days_in_month + 1) %}
                        {% set shifts_on_day = [] %}
                        {% for shift in my_shifts %}
                            {% set shift_date = shift.start.split('T')[0].split('-') %}
                            {% set shift_year = shift_date[0]|int %}
                            {% set shift_month = shift_date[1]|int %}
                            {% set shift_day = shift_date[2]|int %}
                            {% if shift_year == year and shift_month == month and shift_day == day %}
                                {% set _ = shifts_on_day.append(shift) %}
                            {% endif %}
                        {% endfor %}
                        
                        <div class="calendar-day" style="min-height: 80px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; {{ 'background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);' if shifts_on_day else '' }}">
                            <div style="font-size: 0.9rem; font-weight: {{ 'bold' if shifts_on_day else 'normal' }};">{{ day }}</div>
                            {% if shifts_on_day %}
                                {% for shift in shifts_on_day %}
                                    <details style="margin-top: 0.25rem;">
                                        <summary style="cursor: pointer; font-size: 0.7rem; color: var(--primary); background: rgba(255,255,255,0.9); padding: 0.25rem; border-radius: 3px; margin-bottom: 0.25rem;">{{ shift.title }}</summary>
                                        <div style="font-size: 0.65rem; background: white; padding: 0.5rem; border-radius: 3px; margin-top: 0.25rem; border: 1px solid var(--border);">
                                            <div style="margin-bottom: 0.25rem;"><strong>Time:</strong> {{ shift.start.split('T')[1][:5] }} - {{ shift.end.split('T')[1][:5] }}</div>
                                            <div style="margin-bottom: 0.25rem;"><strong>Location:</strong> {{ shift.location or 'TBD' }}</div>
                                            {% if shift.description %}
                                                <div style="margin-bottom: 0.25rem;"><strong>Description:</strong> {{ shift.description }}</div>
                                            {% endif %}
                                        </div>
                                    </details>
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar with shifts and available shifts -->
        <div>
            <h2 style="margin-top: 0;">My Shifts</h2>
            <div id="myShiftsList" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                {% if not my_shifts %}
                    <p style="color: var(--text-light); font-size: 0.9rem;">No shifts assigned yet.</p>
                {% else %}
                    {% for event in my_shifts %}
                        <div class="event-widget card" style="padding: 1rem; font-size: 0.9rem;">
                            <div style="font-weight: bold; margin-bottom: 0.5rem; color: var(--primary);">{{ event.title }}</div>
                            <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem;">{{ event.start.split('T')[0] }}</div>
                            <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.25rem;">{{ event.start.split('T')[1][:5] }} - {{ event.end.split('T')[1][:5] }}</div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem;">
                                <strong>Location:</strong> {{ event.location or 'TBD' }}
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <h3>Available Shifts</h3>
            <div id="availableShiftsList" style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.5rem;">
                {% if not available_shifts %}
                    <p style="color: var(--text-light); font-size: 0.85rem;">No available shifts.</p>
                {% else %}
                    {% for event in available_shifts %}
                        {% set is_pending = user.id in event.get('pending', []) %}
                        {% set is_full = event.assigned|length >= event.capacity|int %}
                        
                        <div class="event-widget card" style="padding: 0.75rem; font-size: 0.85rem;">
                            <div style="font-weight: bold; margin-bottom: 0.25rem;">{{ event.title }}</div>
                            <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">{{ event.start.split('T')[0] }} • {{ event.start.split('T')[1][:5] }}</div>
                            <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.5rem;">{{ event.location or 'TBD' }}</div>
                            
                            {% if is_pending %}
                                <span class="btn btn-secondary" style="cursor: default; padding: 0.4rem; font-size: 0.75rem; text-align: center; display: block;">Pending...</span>
                            {% elif is_full %}
                                <span style="color: var(--text-light); font-size: 0.75rem;">Full</span>
                            {% else %}
                                <form action="/events/{{ event.id }}/subscribe" method="POST">
                                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 0.4rem; font-size: 0.75rem;">I'm Available</button>
                                </form>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <h3>Availability</h3>
            <form action="/availability/submit" method="POST" style="font-size: 0.9rem;">
                <div class="form-group">
                    <label style="font-size: 0.85rem;">Start</label>
                    <input type="datetime-local" name="start" required style="font-size: 0.85rem;">
                </div>
                <div class="form-group">
                    <label style="font-size: 0.85rem;">End</label>
                    <input type="datetime-local" name="end" required style="font-size: 0.85rem;">
                </div>
                <div class="form-group">
                    <label style="font-size: 0.85rem;">Note</label>
                    <input type="text" name="note" placeholder="e.g. Prefer morning shifts" style="font-size: 0.85rem;">
                </div>
                <button type="submit" class="btn btn-secondary" style="width: 100%; padding: 0.5rem; font-size: 0.85rem;">Submit</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
